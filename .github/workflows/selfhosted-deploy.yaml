name: Build and Deploy EMVCoACS

on:
  workflow_dispatch:

env:
  IMAGE_NAME: 192.168.159.130:31506/taly-acs-core-api
  IMAGE_TAG: img-${{ github.run_id }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker
        run: |
          sudo systemctl start docker || true

      - name: Build Docker Image
        run: |
          cd EmvCoACS
          docker build -t $IMAGE_NAME:$IMAGE_TAG .

      - name: Push Docker Image to Registry
        run: |
          cd EmvCoACS
          docker push $IMAGE_NAME:$IMAGE_TAG

      - name: Deploy to Kubernetes
        run: |
          cd EmvCoACS
          sed -i "s#image:.*#image: $IMAGE_NAME:$IMAGE_TAG#g" taly-acs-core-api.yaml
          kubectl apply -f taly-acs-core-api.yaml
